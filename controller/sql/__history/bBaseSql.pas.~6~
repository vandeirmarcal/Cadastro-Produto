{ ------------------------- INFORMAÇÕES GERAIS ---------------------------------
  bBaseSql (Classe base para SQL)
  13/06/2016

  Avisos:
  Vandeir Roberto Marçal
  AJI - Sistemas
 ----------------------------------------------------------------------------- }
unit bBaseSql;

interface

uses DBClient, IBX.IBQuery, Classes, dialogs, IBX.IBDataBase,pDataModule;

 type regCriterio = record
   nomeCampo   : string;
   valorCampo  : string;
   parametro   : string;
   operador    : string;
   condicional : string;
 end;

 type regCampo = record
   nomeCampo   : string;
   valorCampo  : string;
   parametro   : string;
 end;

 type TBaseSQL = class (TPersistent)
   private

   protected
     { --------------------------- ATRIBUTOS --------------------------------- }

     { -- ESTRUTURA --
      Tabelas do sql
     }
     tabelas : TStringList;

     { -- ESTRUTURA --
     SQL batch
     }
     lista_sql : TStringList;

     { -- ESTRUTURA --
      Registro de Critérios
     }
     criterio : array of regCriterio;

     { -- ESTRUTURA --
      Registro de Campo
     }
     campo : array of regCampo;

     { ---------------------------- CONVERTE --------------------------------- }

     {
      Acessa todos os SQL Lazy armazenados (batch)

      Parameters:
          comunicação banco de dados

      Return:
          qtde total de registros processados
     }
     function buildTabelas : string;

     function montaTabela(i : integer) : string;


   public
     { ------------------------ MANUTENÇÃO OBJETOS --------------------------- }


     constructor Create; overload; virtual;

     destructor Destroy  ;  override;

     {
      Constrói a consulta SQL ou parte dela

      Return:
          a consulta SQL
     }
     function buildSQL : string; virtual;abstract;

     {                                                             .
      Limpa as estruturas internas da classe preparando o objeto para ser
      utilizado novamente, sem a necessidade de liberar e criar o objeto
      novamente.
     }
     procedure Clear; virtual;

     {

     }
     function Execute : integer;overload;virtual;
 end;

implementation

uses Sysutils, DateUtils;

// -------------------------------------------------------------------------- //
// --------------------------- MANUTENÇÃO OBJETOS --------------------------- //
// -------------------------------------------------------------------------- //

Constructor TBaseSQL.Create;

begin
  inherited;

  tabelas := TStringList.Create;

  // Lista SQL
  lista_sql := TStringList.Create;
end;

Destructor TBaseSQL.Destroy ;
begin

  // Destruo os objetos
  lista_sql.Free;

  // Herdo a logica padrao
  inherited;
end;

procedure TBaseSQL.Clear;
begin

end;

function TBaseSQL.buildTabelas : string;

var i : integer;
    sql : string;

begin

  sql := tabelas.Strings[i];

  // Retorno
  Result := sql;
end;

function TBaseSQL.montaTabela(i : integer) : string;

var sql : string;

begin

  sql := tabelas.Strings[i];

  // Retorno
  Result := sql;
end;

function TBaseSQL.Execute : integer;

Var
  Script    : TIBQuery;
  iCont     : Integer;
  transacao :  TIBTransaction;

begin
   {
  Try
    Try
      Script := TIBQuery.Create(Nil);
      Result := False;

      with Script do
      begin
        Database := UdmParame.ciGtrans;
        Transaction.StartTransaction;

        Close;
        Prepared := False;
        SQL.Clear;
        SQL.Add(buildSQL);

        if slParametros <> Nil then
        Begin
          For iCont := 0 to slParametros.Count-1 do
          Begin
            Params[iCont].AsString := slParametros[iCont];
          End;
        End;

        Prepared := True;
        ExecSQL;

        if (Transaction <> Nil) then
        begin
          if (Transaction.InTransaction) then
          begin
            Transaction.Commit;
          end;
        end;

      end;

      Result := True;
    except on E:Exception do
      Begin
        if bMsg then
        begin
          MsgErro(PChar('Não foi possível efetuar a atualização do registro.' + #13 +
                        'Erro: ' + dmParame.VerificaErro(E.Message) + #13 +
                        'Origem: ' + E.Message));
        end;
        Application.ProcessMessages;
        MensagemErroScript(psSQL, E.message);
        Abort;
      end;
    End;
  Finally
    FecharDestruirTransacao(objTransacao);
    FecharDestruirDataSet(Script);
  End;
  }
End;


end.
